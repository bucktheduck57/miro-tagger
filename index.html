<!DOCTYPE html>
<html>
  <head>
    <title>Tagger</title>
    <script src="https://unpkg.com/@mirohq/websdk"></script>
    <style>
      #progress-container {
        margin-top: 10px;
        width: 100%;
        max-width: 400px;
        background: #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
      }

      #progress-bar {
        height: 20px;
        width: 0%;
        background-color: #4caf50;
        transition: width 0.3s ease;
      }

      #progress-text {
        margin-top: 5px;
        font-family: sans-serif;
        color: #333;
      }
    </style>
  </head>
  <body>
    <h2>Tagger App</h2>
    <button id="convert">Convert Hashtags to Tags</button>

    <div id="progress-container">
      <div id="progress-bar"></div>
    </div>
    <div id="progress-text"></div>

    <script>
      miro.onReady(() => {
        document.getElementById('convert').addEventListener('click', async () => {
          const convertButton = document.getElementById('convert');
          const progressBar = document.getElementById('progress-bar');
          const progressText = document.getElementById('progress-text');

          convertButton.disabled = true;
          progressBar.style.width = '0%';
          progressText.textContent = 'üîÑ Starting conversion...';

          try {
            const stickyNotes = await miro.board.widgets.get({ type: 'sticky_note' });
            console.log(`üóíÔ∏è Found ${stickyNotes.length} sticky notes`);

            if (stickyNotes.length === 0) {
              progressText.textContent = '‚ö†Ô∏è No sticky notes found.';
              miro.showNotification('‚ö†Ô∏è No sticky notes found.');
              convertButton.disabled = false;
              return;
            }

            const totalNotes = stickyNotes.length;
            let processed = 0;

            const allTags = await miro.board.tags.get();
            const existingTags = Object.fromEntries(
              allTags.map(tag => [tag.title.toLowerCase(), tag.id])
            );

            for (const note of stickyNotes) {
              const content = note.fields?.content || '';
              const hashtags = content.match(/#(\w+)/g)?.map(tag => tag.substring(1).toLowerCase()) || [];

              const uniqueTags = [...new Set(hashtags)];

              if (uniqueTags.length === 0) {
                console.log('‚ûñ No hashtags found in note.');
                processed++;
                updateProgress(processed, totalNotes);
                continue;
              }

              const tagIds = [];

              for (const name of uniqueTags) {
                if (existingTags[name]) {
                  tagIds.push(existingTags[name]);
                } else {
                  const newTag = await miro.board.tags.create({ title: name });
                  console.log(`‚ú® Created new tag: ${name}`);
                  existingTags[name] = newTag.id;
                  tagIds.push(newTag.id);
                }
              }

              await miro.board.widgets.update([{
                id: note.id,
                tagIds: tagIds,
              }]);

              console.log(`‚úÖ Updated note ${note.id} with tags: [${uniqueTags.join(', ')}]`);

              processed++;
              updateProgress(processed, totalNotes);
            }

            progressText.textContent = '‚úÖ All hashtags converted to tags!';
            miro.showNotification('‚úÖ Hashtags converted to tags!');

          } catch (error) {
            console.error('‚ùå Error occurred:', error);
            progressText.textContent = '‚ùå Error occurred! Check console.';
            miro.showNotification('‚ùå Something went wrong. See console.');
          } finally {
            convertButton.disabled = false;
          }

          function updateProgress(processed, total) {
            const percent = ((processed / total) * 100).toFixed(1);
            progressBar.style.width = percent + '%';
            progressText.textContent = `üöß Processed ${processed} of ${total} notes (${percent}%)`;
          }
        });
      });
    </script>
  </body>
</html>
