<!DOCTYPE html>
<html>
  <head>
    <title>Tagger</title>
    <script src="https://unpkg.com/@mirohq/websdk"></script>
  </head>
  <body>
    <h2>Tagger App</h2>
    <button id="convert">Convert Hashtags to Tags</button>

    <script>
      // Make sure the SDK is ready
      miro.onReady(() => {
        document.getElementById('convert').addEventListener('click', async () => {
          const stickyNotes = await miro.board.widgets.get({ type: 'sticky_note' });

          for (const note of stickyNotes) {
            const hashtags = note.plainText.match(/#(\w+)/g)?.map(tag => tag.substring(1)) || [];
            if (hashtags.length === 0) continue;

            const allTags = await miro.board.tags.get();
            const existingTags = Object.fromEntries(allTags.map(tag => [tag.title, tag.id]));

            const tagIds = [];

            for (const name of hashtags) {
              if (existingTags[name]) {
                tagIds.push(existingTags[name]);
              } else {
                const newTag = await miro.board.tags.create({ title: name });
                tagIds.push(newTag.id);
              }
            }

            await miro.board.widgets.update({
              id: note.id,
              tagIds: tagIds,
            });
          }

          miro.showNotification('âœ… Hashtags converted to tags!');
        });
      });
    </script>
  </body>
</html>
